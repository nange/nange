- 今天看东旭写了篇文章：[Building a database in the 2020s](http://_.0xffff.me/build-database-in-2020s.html)，还是很有收获，摘录一些要点。
	- 首先提到今天开发者对数据库的期待：
		- Cost-effective(划算)。最好用多少付多少。
		- Ease-of-use matters(易用)。最好把基础设施都隐藏起来，用户不用感知；另外SQL依旧是最易用的和数据库打交道的方式。
		- Unified(统一)。目前情况下，大部分时候，即使开发一个简单的应用，后台都可能需要用到复杂的技术栈，如数据库、数据仓库、消息队列等等；还有一个头疼的点就是扩缩容(scale)，在终端用户看来很小的一个改动点，在后台都可能需要不同的基础设施技术栈并且是有不同伸缩规模要求的。
	- 一个现代的数据库架构就是要试图去简化和统一底层技术栈，从而让开发者构建维护应用变得简单。基于这些痛点和趋势：
		- [[云原生]](Cloud-native)设计是非常重要的。其不只是分离了存储和计算，而是分离了所有它能分离的东西。
		- [[Serverless]] 可能会是最终的产品形态。
		- 对于新一代数据库，[[HTAP]]是必定要有的技术路线。
	- 基于这些想法和假设，[[TiDB]]过去一年对底层做了显著的重新设计和重构，下面是一些要点：
		- **成为一个服务而不是软件**
		  collapsed:: true
			- 今天的数据库，很明显了，我们应该提供云服务能力（很快会是Serverless的形式）。但很多人（特别是数据库内核开发人员）都低估了提供云服务的复杂度。
			- 提供云服务需要深刻理解用户需求以及应用是如何使用数据库的，同时也需要具有设计和实现一个能够支持很宽泛的工作负载的健壮又可伸缩的架构。另外，当然也需要云基础设施方面的专家（比如S3/EBS），自动化，DevOps；这也是传统数据库开发者要遇到的挑战。
			- 云上的基础设施和以前本地的基础设施相比，已经发生了很大的变化，这带来了新的挑战和复杂性：
				- 在云上，以Service API的形式，提供了各种各样，几乎无限的资源；并且这些资源的获取是可以通过代码来完成的，这是一种革命性的改变。
				- 所有资源都是明码标价的。所以程序的优化方向也发生了一些改变，从过去单一维度的更好的性能，变成了：尝试以最少的钱去办最大的事。
			- 这就要求我们的数据库首先要称为多个自治的微服务网络，这些微服务不一定在不同的机器上，但是它们需要能被远程访问到；同时它们应该是无状态（stateless）的，从而实现快速的弹性伸缩。一些例子：
				- 在云上，计算资源明显比存储资源更贵，如果计算和存储是捆绑在一起的，就没办法利用到这种价格优势。同时计算和存储资源的需求量明显也是不同的（特别是对于OLAP来说）。另外对于分布式数据库，伸缩的速度也是重要的用户体验指标，当存储和计算分离之后，伸缩速度就会变得极快：1. 启动一些计算节点 2. cache 预热
				- 一些数据库内部组件会被拆分为服务。比如DDL，变为DDL-as-a-Service，传统的DDL操作会明显影响数据库性能，比如添加索引，涉及到数据回填，这回引发OLTP请求的性能抖动。DDL这类操作其实是一种全局的、偶尔发生、可重计算、离线、可重加载的模块，并且有一个共享的存储层（S3），这种模块是理想的，可拆分成一个单独的无状态服务，它和OLTP存储引擎通过S3共享数据。这样做有明显的好处：
					- 在做DDL操作时，几乎不会影响到OLTP的性能
					- 这种按需的架构，降低了成本
			- 还有一些相似的例子，如：Logging，LSM-Tree compaction，data compression，meta information等。在云原生版本的TiDB中，使用现卖实例（Spot Instances）来做远端存储Compaction，成本下降非常显著
			- 另外一个重要的考虑点是QoS(Quality of service)，大概的点是：
				- 需要定义控制单位(units of control)：WCU(Write capacity unit) 和 RCU(Read capacity unit)，否则没法申请和调度资源，甚至无法定价
				- 多租户(Multi-tenancy)是必须的。租户之间能够共享硬件和集群资源，这带来了问题：如何避免受邻里影响(Noisy Neiberhood problem)？如何设计限制策略？如何避免因共享元数据服务而不堪重负(overwhelmed)？如何处理极端热点？...... 好在这些问题在今年[[DynamoDB]]论文中基本上已经有明确的解决方案。
					- 英文原文：https://www.usenix.org/system/files/atc22-elhemali.pdf
					- 中文解读：http://blog.0xffff.me/posts/dynamodb-2022/
		- **云服务能依赖什么？**
		  collapsed:: true
			- 作为第三方数据库提供商，跨云的能力是天然的优势，深度依赖某个特定的云服务将会损失掉自己的灵活性。如何选择依赖项，有以下一些原则：
				- 依赖接口和协议，而不是具体实现。暴露给其他服务的接口，需要时通用的，一个例子是：VPC Peering and PrivateLink，如果遵守这个原则，就肯定会选择PrivateLink，因为VPC Peering需要暴露更多的细节给用户
				- 如果有行业标准，就遵从行业标准，如(S3, POSIX file system)
				- 安全是唯一的例外。如果没有一个好的跨云的安全抽象，就不要造轮子。直接使用云上已经在使用的，如key management, IAM。不要再发明一套自己的东西
			- 一些TiDB的依赖选择：
				- 存储：S3非常关键。几乎每个云厂商都提供兼容S3的对象存储服务。并且像LSM这类层级结构的存储数据库，可以很好的利用S3的特性，如：本地磁盘存储更上层的热数据，S3存储更底层的老数据，Compaction的处理就是交换更上层的数据到S3。数据到S3后，[[Remote Compaction]]就可以开始工作了。
				- 计算：容器 and Kubernetes。现在各个云厂商都有自管理的K8s服务，K8s是云上的操作系统。
			- 在云上是否要一个文件系统的抽象？可能有这个抽象更好，原因是因为Cache。这样可以在访问文件之上添加一个Cache层。另外很多Unix的工具也能重用。
		- **终端用户体验是优化的方向指导**
		  collapsed:: true
			- Serverless让配置被隐藏了起来，减少用户的精神负担
			- 极快的启动速度，扩展了使用场景
			- 归零。大部分时候更便宜，小的场景甚至免费
	- 未来的挑战
		- 基于S3+MVCC。理论上可实现像Git一样的数据版本控制：`git checkout <branch>`
		- 新业务模型。基于云基础设施支持，数据库提供商可以提供新的业务模型，用户无需管理基础设施。
		- 过去数据库提供商更多聚焦在数据库内核开发，而提供云服务后，除了数据库引擎开发，还有云服务操作等的开发，这涉及到一个大的组织架构调整，如果很好的过渡？这是个问题。
-